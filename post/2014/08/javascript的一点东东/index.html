<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="referrer" content="always"><meta name="author" content="bukas"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="theme-color" content="#c05b4d"><meta name="msapplication-navbutton-color" content="#c05b4d"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#c05b4d"><meta name="format-detection" content="telphone=no, email=no"><meta name="msapplication-TileColor" content="#c05b4d"><meta name="screen-orientation" content="portrait"><meta name="x5-orientation" content="portrait"><meta name="apple-touch-fullscreen" content="yes"><meta name="full-screen" content="yes"><meta name="x5-fullscreen" content="true"><meta name="x5-page-mode" content="app"><meta name="browsermode" content="application"><meta name="msapplication-config" content="/browserconfig.xml"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileImage" content="/image/icon/144x144.png"><link rel="apple-touch-icon" sizes="60x60" href="/image/icon/60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/image/icon/72x72.png"><link rel="apple-touch-icon" sizes="120x120" href="/image/icon/120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/image/icon/144x144.png"><link rel="icon" type="image/png" sizes="192x192" href="/image/icon/192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/image/icon/32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/image/icon/96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/image/icon/16x16.png"><meta name="description" content="javascript的一点东东"><meta name="keywords" content="javascript, 前端博客"><meta name="baidu-site-verification" content="SWwJlIQz43"><meta name="google-site-verification" content="9c8gt3muwQc_44xCxDE2Op-g1Wn9C2vzhYP-rXVLqlU"><link rel="amphtml" href="https://mercury.postlight.com/amp?url=https://www.noonme.com/post/2014/08/javascript的一点东东/"><link rel="alternate" href="/rss.xml" title="前端博客"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0"><link rel="canonical" href="https://www.noonme.com/post/2014/08/javascript的一点东东/"><link rel="stylesheet" href="/lib/fancybox/jquery.fancybox.css"><link rel="stylesheet" href="/lib/nprogress/nprogress.min.css"><link rel="stylesheet" href="/css/style.css?v=2.11.0"><script id="baidu_analytics">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b55278bdcb7115441071d19eb18b0d97";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-49034721-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-49034721-1")</script><script id="baidu_push">!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="//cdn1.lncld.net/static/js/3.1.1/av-min.js"></script><script id="leancloud">AV.init({appId:"xoEVsPhgw6N3YPfMBXnq6q1K-gzGzoHsz",appKey:"WMWiVHdG2AKdDrC6kgUCoBnU"})</script><script>window.config={leancloud:{app_id:"xoEVsPhgw6N3YPfMBXnq6q1K-gzGzoHsz",app_key:"WMWiVHdG2AKdDrC6kgUCoBnU"},toc:!0,fancybox:!0,pjax:!0,latex:!1}</script><title>javascript的一点东东 - 前端博客</title></head><body><div id="mobile-navbar" class="mobile-navbar"><div class="mobile-header-logo"><a href="/." class="logo">前端博客</a></div><div class="mobile-navbar-icon"><span></span> <span></span> <span></span></div></div><nav id="mobile-menu" class="mobile-menu slideout-menu"><ul class="mobile-menu-list"><a href="/"><li class="mobile-menu-item">首页</li></a><a href="/archives/"><li class="mobile-menu-item">归档</li></a><a href="/about"><li class="mobile-menu-item">关于</li></a></ul></nav><div class="container" id="mobile-panel"><header id="header" class="header"><div class="logo-wrapper"><a href="/." class="logo">前端博客</a></div><nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item"><a class="menu-item-link" href="/">首页</a></li><li class="menu-item"><a class="menu-item-link" href="/archives/">归档</a></li><li class="menu-item"><a class="menu-item-link" href="/about">关于</a></li></ul></nav></header><main id="main" class="main"><div class="content-wrapper"><div id="content" class="content"><article class="post"><header class="post-header"><h1 class="post-title">javascript的一点东东</h1><div class="post-meta"><span class="post-time">2014-08-19 </span><span class="post-category"><a href="/categories/technology/">technology</a> </span><span class="post-visits" data-url="/post/2014/08/javascript的一点东东/" data-title="javascript的一点东东">阅读次数 0</span></div></header><div class="post-content"><p>昨晚在某群看到有人出了一道题，感觉挺有意思。然后便想着结合最近自己看到的一些关于js的东东，整理出一篇文章来。</p><a id="more"></a><p>首先说下题目吧：</p><p>要求实现函数<code>add(2)(4)...</code>，add函数可以后面接n个括号，然后函数返回这些传参的和，要考虑扩展性。</p><p>先来看一个不那么靠谱的：</p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> add = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">y</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">z</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">return</span> x+y+z;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">add(<span class="number">3</span>)(<span class="number">2</span>)(<span class="number">2</span>); <span class="comment">//7</span></span><br></pre></td></tr></table></figure><p></p><p>这样的实现只能计算3个数字的和，而题目要求是n个呢？怎么办？循环吗？怎么循环？</p><p><strong>arguments.callee</strong></p><p>聪明的同学此时可能会相到函数<em>自调用</em>。</p><p>先来看个栗子：</p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">factorial</span>(<span class="params">n</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> !(n &gt; <span class="number">1</span>) ? <span class="number">1</span> : <span class="built_in">arguments</span>.callee(n - <span class="number">1</span>) * n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">factorial(<span class="number">3</span>)  <span class="comment">//6  返回3的阶乘</span></span><br></pre></td></tr></table></figure><p></p><blockquote><p><code>arguments.callee</code>：指向当前正在执行的函数 <code>arguments.caller</code>：指向调用当前正在执行的函数的函数,请使用arguments.callee.caller代替</p></blockquote><p>看到这里你是不是觉得信心满满了呢？其实如果只是到这里你可能还是不知道该怎么做。没关系，先一起来看看别人的代码吧。</p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> callee = <span class="built_in">arguments</span>.callee;</span><br><span class="line">	callee.val = (callee.val || <span class="number">0</span>) + x;</span><br><span class="line">	callee.toString = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.val;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> callee;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">add(<span class="number">3</span>)(<span class="number">4</span>)(<span class="number">3</span>)(<span class="number">5</span>)   <span class="comment">//15</span></span><br><span class="line">add(<span class="number">1</span>)(<span class="number">3</span>)  <span class="comment">//4</span></span><br></pre></td></tr></table></figure><p></p><p>哈哈，是不是就这样实现了呢？</p><p>到这里是不是就很完美了呢？但是有些同学可能会说<code>arguments.callee</code>在严格模式下不能使用的呢？ok,那我们就继续来修改一下吧。</p><p><strong>闭包</strong></p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> sum = x;</span><br><span class="line">  	<span class="keyword">var</span> tmp = <span class="function"><span class="keyword">function</span>(<span class="params">y</span>) </span>&#123;</span><br><span class="line">        sum = sum + y;</span><br><span class="line">        <span class="keyword">return</span> tmp;</span><br><span class="line">  	&#125;;</span><br><span class="line">  	tmp.toString =<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line"> 	&#125;;</span><br><span class="line">  	<span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">add(<span class="number">3</span>)(<span class="number">4</span>)(<span class="number">3</span>)(<span class="number">5</span>)   <span class="comment">//15</span></span><br><span class="line">add(<span class="number">1</span>)(<span class="number">3</span>)  <span class="comment">//4</span></span><br></pre></td></tr></table></figure><p></p><p><strong>toString</strong></p><p>接着看看关于toString的东东，试试返回值是什么呢?</p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10.</span>toString.length</span><br><span class="line"><span class="number">10</span>[<span class="string">'toString'</span>].length</span><br><span class="line"><span class="number">10</span> .toString()</span><br><span class="line"><span class="number">10.</span>.toString()</span><br></pre></td></tr></table></figure><p></p><p><strong>函数声明与变量声明</strong></p><p>再来看看函数声明与变量声明</p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a的值？</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span> <span class="title">a</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> a;</span><br><span class="line">	<span class="built_in">console</span>.log(a);</span><br><span class="line">)(<span class="built_in">window</span>); <span class="comment">// =&gt; function a() &#123; return 2; &#125;</span></span><br><span class="line"></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	a = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="number">1</span>; &#125;;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">a</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    	<span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">var</span> a;</span><br><span class="line">	<span class="keyword">return</span> a;</span><br><span class="line">&#125;)(<span class="built_in">window</span>);  <span class="comment">// =&gt; function () &#123; return 1; &#125;</span></span><br></pre></td></tr></table></figure><p></p><p>弄清楚上面的问题，要理解清楚函数声明提升和变量提升。来说说js的运行机制：</p><ol><li>读入第一个代码段（js执行引擎并非一行一行地执行程序，而是一段一段地分析执行的）</li><li>做语法分析，有错则报语法错误（比如括号不匹配等），并跳转到6</li><li>对函数声明（FunctionDeclaration，也就是 funcion fname(args){code}）做“预解析”（永远不会报错的，因为只解析正确的声明）</li><li>对变量声明（用var声明的）做“预解析”，如果此时function是作为一个变量，整个声明语句是一个表达式（FunctionExpresion）。这是因为处理变量声明仅仅是标记了这个变量名，而不执行表达式。也就是说在代码开始运行之前，变量声明的是一个变量了（它的值当然是undefined),而要等代码运行到的时候才执行</li><li>执行代码段，有错则报错（比如变量未定义）</li><li>如果还有下一个代码段，则读入下一个代码段，重复2</li><li>结束</li></ol><p><strong>通过字符串来创建DOM节点</strong></p><p>在当前页面中新增了一个div元素。使用jquery，这个只需要一行代码就搞定了：</p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> test = $(<span class="string">'&lt;div&gt;Test&lt;/div&gt;'</span>);</span><br><span class="line"></span><br><span class="line">$(<span class="string">'body'</span>).append(test);</span><br></pre></td></tr></table></figure><p></p><p>如果不用jquery呢？</p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toDom</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> temp = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line">	temp.innerHTML = str;</span><br><span class="line">	<span class="keyword">return</span> temp.childNodes[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> test = toDom(<span class="string">'&lt;div&gt;Test&lt;/div&gt;'</span>);</span><br><span class="line"><span class="built_in">document</span>.querySelector(<span class="string">'body'</span>).appendChild(test);</span><br></pre></td></tr></table></figure><p></p><p>我们定义了一个自己的工具方法toDom，这个方法做了如下事情：首先创建一个临时div元素，然后设定它的innerTHML属性，然后返回该DIV元素的第一个节点。然而下面的代码会获得不同的结果：</p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> tableRow = $(<span class="string">'&lt;tr&gt;&lt;td&gt;Simple text&lt;/td&gt;&lt;/tr&gt;'</span>);</span><br><span class="line">$(<span class="string">'body'</span>).append(tableRow);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> tableRow = toDom(<span class="string">'&lt;tr&gt;&lt;td&gt;Simple text&lt;/td&gt;&lt;/tr&gt;'</span>);</span><br><span class="line"><span class="built_in">document</span>.querySelector(<span class="string">'body'</span>).appendChild(tableRow);</span><br></pre></td></tr></table></figure><p></p><p>从这个页面的表面上看，没有什么不同。但是我们通过chrome的开发工具查看生成的HTML标记的话，会得到一个有趣的结果，创建了一个文本元素。</p><p>貌似我们的toDom 只创建了一个文本节点而不是tr标签。但是jquery却不知何故可以正常运行。问题的原因是在浏览器端是通过解析器来解析含有HTML元素的字符串的。解析器会忽略掉那些放错上下文位置的标记，因此我们只获得了文本节点。row标签没有包含在正确的table标签中，这对浏览器的解析器来说就是不合法的。</p><p>jquery通过创建正确的上下文后然后做些转换，可以成功的解决这个问题。如果我们深入到源码中可以看到下面的一个映射：</p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wrapMap = &#123;</span><br><span class="line">	option: [<span class="number">1</span>, <span class="string">'&lt;select multiple="multiple"&gt;'</span>, <span class="string">'&lt;/select&gt;'</span>],</span><br><span class="line">	legend: [<span class="number">1</span>, <span class="string">'&lt;fieldset&gt;'</span>, <span class="string">'&lt;/fieldset&gt;'</span>],</span><br><span class="line">	area: [<span class="number">1</span>, <span class="string">'&lt;map&gt;'</span>, <span class="string">'&lt;/map&gt;'</span>],</span><br><span class="line">	param: [<span class="number">1</span>, <span class="string">'&lt;object&gt;'</span>, <span class="string">'&lt;/object&gt;'</span>],</span><br><span class="line">	thead: [<span class="number">1</span>, <span class="string">'&lt;table&gt;'</span>, <span class="string">'&lt;/table&gt;'</span>],</span><br><span class="line">	tr: [<span class="number">2</span>, <span class="string">'&lt;table&gt;&lt;tbody&gt;'</span>, <span class="string">'&lt;/tbody&gt;&lt;/table&gt;'</span>],</span><br><span class="line">	col: [<span class="number">2</span>, <span class="string">'&lt;table&gt;&lt;tbody&gt;&lt;/tbody&gt;&lt;colgroup&gt;'</span>, <span class="string">'&lt;/colgroup&gt;&lt;/table&gt;'</span>],</span><br><span class="line">	td: [<span class="number">3</span>, <span class="string">'&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;'</span>, <span class="string">'&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;'</span>],</span><br><span class="line">	_default: [<span class="number">1</span>, <span class="string">'&lt;div&gt;'</span>, <span class="string">'&lt;/div&gt;'</span>]</span><br><span class="line">&#125;;</span><br><span class="line">wrapMap.optgroup = wrapMap.option;</span><br><span class="line">wrapMap.tbody = wrapMap.tfoot = wrapMap.colgroup = wrapMap.caption = wrapMap.thead;</span><br><span class="line">wrapMap.th = wrapMap.td;</span><br></pre></td></tr></table></figure><p></p><p>任何一个需要特殊处理的元素都对应到一个数组中，目的就是为了构建一个正确的DOM节点。例如，对于tr元素，我们要创建一个带有tbody的table中，需要包裹两层。</p><p>虽然有了map，但是我们还是得先去查找到字符串中的结束标签是啥。下面的代码可以从<code>&lt;tr&gt;&lt;td&gt;Simple text&lt;/td&gt;&lt;/tr&gt;</code>抽取出tr标签。</p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> match = <span class="regexp">/&lt;\s*\w.*?&gt;/g</span>.exec(str);</span><br><span class="line"><span class="keyword">var</span> tag = match[<span class="number">0</span>].replace(<span class="regexp">/&lt;/g</span>, <span class="string">''</span>).replace(<span class="regexp">/&gt;/g</span>, <span class="string">''</span>);</span><br></pre></td></tr></table></figure><p></p><p>剩下来要做的就是找到属性上下文，然后返回DOM元素。下面是toDom方法的最终版本：</p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toDom</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> wrapMap = &#123;</span><br><span class="line">		option: [<span class="number">1</span>, <span class="string">'&lt;select multiple="multiple"&gt;'</span>, <span class="string">'&lt;/select&gt;'</span>],</span><br><span class="line">		legend: [<span class="number">1</span>, <span class="string">'&lt;fieldset&gt;'</span>, <span class="string">'&lt;/fieldset&gt;'</span>],</span><br><span class="line">		area: [<span class="number">1</span>, <span class="string">'&lt;map&gt;'</span>, <span class="string">'&lt;/map&gt;'</span>],</span><br><span class="line">		param: [<span class="number">1</span>, <span class="string">'&lt;object&gt;'</span>, <span class="string">'&lt;/object&gt;'</span>],</span><br><span class="line">		thead: [<span class="number">1</span>, <span class="string">'&lt;table&gt;'</span>, <span class="string">'&lt;/table&gt;'</span>],</span><br><span class="line">		tr: [<span class="number">2</span>, <span class="string">'&lt;table&gt;&lt;tbody&gt;'</span>, <span class="string">'&lt;/tbody&gt;&lt;/table&gt;'</span>],</span><br><span class="line">		col: [<span class="number">2</span>, <span class="string">'&lt;table&gt;&lt;tbody&gt;&lt;/tbody&gt;&lt;colgroup&gt;'</span>, <span class="string">'&lt;/colgroup&gt;&lt;/table&gt;'</span>],</span><br><span class="line">		td: [<span class="number">3</span>, <span class="string">'&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;'</span>, <span class="string">'&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;'</span>],</span><br><span class="line">		_default: [<span class="number">1</span>, <span class="string">'&lt;div&gt;'</span>, <span class="string">'&lt;/div&gt;'</span>]</span><br><span class="line">	&#125;;</span><br><span class="line">	wrapMap.optgroup = wrapMap.option;</span><br><span class="line">	wrapMap.tbody = wrapMap.tfoot = wrapMap.colgroup = wrapMap.caption = wrapMap.thead;</span><br><span class="line">	wrapMap.th = wrapMap.td;</span><br><span class="line">	<span class="keyword">var</span> element = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line">	<span class="keyword">var</span> match = <span class="regexp">/&lt;\s*\w.*?&gt;/g</span>.exec(str);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(match != <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">var</span> tag = match[<span class="number">0</span>].replace(<span class="regexp">/&lt;/g</span>, <span class="string">''</span>).replace(<span class="regexp">/&gt;/g</span>, <span class="string">''</span>);</span><br><span class="line">		<span class="keyword">var</span> map = wrapMap[tag] || wrapMap._default, element;</span><br><span class="line">		str = map[<span class="number">1</span>] + str + map[<span class="number">2</span>];</span><br><span class="line">		element.innerHTML = str;</span><br><span class="line">		<span class="comment">// Descend through wrappers to the right content</span></span><br><span class="line">		<span class="keyword">var</span> j = map[<span class="number">0</span>]+<span class="number">1</span>;</span><br><span class="line">		<span class="keyword">while</span>(j--) &#123;</span><br><span class="line">			element = element.lastChild;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// if only text is passed</span></span><br><span class="line">		element.innerHTML = str;</span><br><span class="line">		element = element.lastChild;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> element;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>注意下，我们有个判断 match != null条件用于判断string中是否有tag标签，如果没有我们只是简单的返回文本节点。这里我们传入了正确的标签，所以浏览器能够创建一个正常的DOM节点了。在代码的最后部分可以看到，通过使用一个while循环，我们一直深入到我们想要的那个tag节点后返回给了调用者。</p><p><strong>计算属性</strong></p><p>计算属性非常有趣。计算属性就是用一个函数来充当属性,让我们来看下一个简单例子：</p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> User = &#123;</span><br><span class="line">	firstName: <span class="string">'John'</span>,</span><br><span class="line">	lastName: <span class="string">'Bukas'</span>,</span><br><span class="line">	name: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="comment">// getter + setter</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p>我们想要实现调用的效果如下：</p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(User.name); <span class="comment">// John Bukas</span></span><br><span class="line">User.name = <span class="string">'John Dony'</span>;</span><br><span class="line"><span class="built_in">console</span>.log(User.firstName); <span class="comment">// John</span></span><br><span class="line"><span class="built_in">console</span>.log(User.lastName); <span class="comment">// Dony</span></span><br><span class="line"><span class="built_in">console</span>.log(User.name); <span class="comment">// John Dony</span></span><br></pre></td></tr></table></figure><p></p><p><strong>Object.defineProperty</strong></p><p>JS值有个内置的特性可以帮助我们实现我们的想法。接着看下面的代码：</p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> User = &#123;</span><br><span class="line">	firstName: <span class="string">'John'</span>,</span><br><span class="line">	lastName: <span class="string">'Bukas'</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(User, <span class="string">"name"</span>, &#123;</span><br><span class="line">	<span class="keyword">get</span>: function() &#123; </span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.firstName + <span class="string">' '</span> + <span class="keyword">this</span>.lastName;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="keyword">set</span>: function(value) &#123; </span><br><span class="line">		<span class="keyword">var</span> parts = value.toString().split(<span class="regexp">/ /</span>);</span><br><span class="line">		<span class="keyword">this</span>.firstName = parts[<span class="number">0</span>];</span><br><span class="line">		<span class="keyword">this</span>.lastName = parts[<span class="number">1</span>] ? parts[<span class="number">1</span>] : <span class="keyword">this</span>.lastName;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p></p><p><code>Object.defineProperty</code>方法接受一个上下文、属性名称以及get/set方法。我们要做的就是实现里面的两个方法，仅此而已。我们将运行上面的代码并且能够获得到期望的结果。</p><p><code>Object.defineProperty</code>确实是我们需要的，但是我们不想强制每个开发者每次都重写这个方法。我们只需要一个定义类的方法，在这里，我们会写一个使用函数Computize用来把对象中的函数中传递的名称转换成对象中属性的名称。我们想使用set来设定名称，同时使用get来获取名称。我们先在函数的原型中增加我们的逻辑代码：</p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.computed = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> &#123; <span class="attr">computed</span>: <span class="literal">true</span>, <span class="attr">func</span>: <span class="keyword">this</span> &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p></p><p>一旦我们增加了上面的代码，我们就会为每个函数增加了一个<code>.computed()</code>方法了。</p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	...</span><br><span class="line">&#125;.computed()</span><br></pre></td></tr></table></figure><p></p><p>结果就是name属性不在是函数了，而是一个拥有computed为true的属性和一个func属性的对象。真正的魔法发生在自定义辅助方法的实现上，它贯穿于整个对象的属性上。我们会在计算属性上使用<code>Object.defineProperty</code>：</p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Computize = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">var</span> prop <span class="keyword">in</span> obj) &#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">typeof</span> obj[prop] == <span class="string">'object'</span> &amp;&amp; obj[prop].computed === <span class="literal">true</span>) &#123;</span><br><span class="line">			<span class="keyword">var</span> func = obj[prop].func;</span><br><span class="line">			<span class="keyword">delete</span> obj[prop];</span><br><span class="line">			<span class="built_in">Object</span>.defineProperty(obj, prop, &#123;</span><br><span class="line">				<span class="keyword">get</span>: func,</span><br><span class="line">				<span class="keyword">set</span>: func</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>注意我们删除了原生的属性名称。在一些浏览器中<code>Object.defineProperty</code>只运行于还没有存在的属性上。</p><p>下面是一个使用<code>.computed()</code>方法最终版本的User对象。</p><p></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> User = Computize(&#123;</span><br><span class="line">  firstName: <span class="string">'John'</span>,</span><br><span class="line">  lastName: <span class="string">'Bukas'</span>,</span><br><span class="line">  name: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">arguments</span>.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> parts = <span class="built_in">arguments</span>[<span class="number">0</span>].toString().split(<span class="regexp">/ /</span>);</span><br><span class="line">      <span class="keyword">this</span>.firstName = parts[<span class="number">0</span>];</span><br><span class="line">      <span class="keyword">this</span>.lastName = parts[<span class="number">1</span>] ? parts[<span class="number">1</span>] : <span class="keyword">this</span>.lastName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.firstName + <span class="string">' '</span> + <span class="keyword">this</span>.lastName;</span><br><span class="line">  &#125;.computed()</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p></p><p>在这个返回全名的函数中可以观察到firstName和lastName的变化。在这里判断是否判断了参数，如果传了参数则把他们分设到firstName和lastName中。</p></div><div class="post-copyright"><p class="copyright-item"><span>原文作者: </span><a href="https://www.noonme.com">bukas</a></p><p class="copyright-item"><span>原文链接: </span><a href="https://www.noonme.com/post/2014/08/javascript的一点东东/">https://www.noonme.com/post/2014/08/javascript的一点东东/</a></p><p class="copyright-item"><span>许可协议: </span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a></p></div><div class="post-reward"><input type="checkbox" name="reward" id="reward" hidden> <label class="reward-button" for="reward">赞赏支持</label><div class="qr-code"><label class="qr-code-image" for="reward"><img class="image" src="/image/reward/wechat.png" title="wechat"></label> <label class="qr-code-image" for="reward"><img class="image" src="/image/reward/alipay.png" title="alipay"></label></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/javascript/">javascript</a></div><nav class="post-nav"><a class="prev" href="/post/2014/09/如何对Backbone.Collection进行过滤操作/"><i class="iconfont icon-left"></i> <span class="prev-text nav-default">如何对Backbone.Collection进行过滤操作</span> <span class="prev-text nav-mobile">上一篇</span> </a><a class="next" href="/post/2014/08/javascript原生函数搜集/"><span class="next-text nav-default">javascript原生函数搜集</span> <span class="prev-text nav-mobile">下一篇</span> <i class="iconfont icon-right"></i></a></nav></footer></article></div><div class="comments" id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div></main><footer id="footer" class="footer"><div class="social-links"><a href="mailto:yhz1219@gmail.com" class="iconfont icon-email" title="email"></a> <a href="https://github.com/huanz" class="iconfont icon-github" title="github"></a> <a href="http://weibo.com/2335228667/" class="iconfont icon-weibo" title="weibo"></a> <a href="/rss.xml" class="iconfont icon-rss" title="rss"></a></div><div class="copyright"><span class="power-by">由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动 </span><span class="division">|</span> <span class="theme-info">主题 - <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a> </span><span class="copyright-year">&copy;2015 - 2019<span class="heart"> <i class="iconfont icon-heart"></i> </span><span class="author">bukas</span> <span>京ICP备18012917号</span></span></div></footer><div class="back-to-top" id="back-to-top"><i class="iconfont icon-up"></i></div></div><script>var disqus_config=function(){this.page.url="https://www.noonme.com/post/2014/08/javascript的一点东东/",this.page.identifier="post/2014/08/javascript的一点东东/",this.page.title="javascript的一点东东"};!function(){var t=document,e=t.createElement("script");e.src="//bukas.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><script src="/lib/jquery/jquery.min.js"></script><script src="/lib/slideout/slideout.js"></script><script src="/lib/fancybox/jquery.fancybox.pack.js"></script><script src="/lib/pjax/jquery.pjax.min.js"></script><script src="/lib/nprogress/nprogress.min.js"></script><script src="/js/src/even.js?v=2.11.0"></script></body></html>